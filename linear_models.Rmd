---
title: "Linear Classification Models"
output: html_notebook
---

```{r}
source("2-model_tests.R")
```

## Partial Least Squares
```{r}
plsGrid <- expand.grid(.ncomp = 1:10)
```

```{r}
if (!file.exists("models/pls_dv.Rds")) {
    set.seed(1056)
    pls.dv <- train(
        Party ~ .,
        data = train.dv[, -c(1, hc.dv)],
        method = "pls",
        trControl = trCtrl,
        metric = "ROC",
        tuneGrid = plsGrid,
        preProcess = c("nzv", "pca")
    )
    
    saveRDS(pls.dv, "models/pls_dv.Rds")

} else {
    library(pls)
    pls.dv <- readRDS("models/pls_dv.Rds")
}
```

```{r}
set.seed(1056)
pls.dv <- train(
    Party ~ .,
    data = train.dv[, -c(1, hc.dv)],
    method = "pls",
    trControl = trCtrl,
    metric = "ROC",
    tuneGrid = expand.grid(.ncomp = 3),
    preProcess = c("nzv", "pca")
)

```


```{r}
set.seed(1056)
glmnet.mca <- train(
    Party ~ .,
    # data = train.dv[, -1],
    data = train.mca[, -1],
    method = "glmnet",
    trControl = trCtrl,
    metric = "ROC",
    tuneGrid = expand.grid(.alpha = 0.1, .lambda = 0.0044944)
    # tuneLength = 10
    # tuneGrid = expand.grid(.ncomp = 1:5)
    # preProcess = c("nzv", "ica")
)
```

```{r}
lda.ica
```

```{r}
pred.lda.ica <- predict(lda.ica, valid.mca)
confusionMatrix(pred.lda.ica, valid.party)
```




```{r}
set.seed(1056)
kpls.dv <- train(
    Party ~ .,
    data = train.dv[, -c(1, hc.dv)],
    # data = train.set[, -1],
    method = "kernelpls",
    trControl = trCtrl,
    metric = "ROC",
    tuneGrid = plsGrid,
    preProcess = c("center", "scale")
)
```

```{r}
kpls.dv
```

```{r}
# pred.kpls.dv <- predict(kpls.dv, valid.set[, -1])
pred.kpls.dv <- predict(kpls.dv, valid.dv[, -c(1, hc.dv)])
confusionMatrix(pred.kpls.dv, valid.party)
```

```{r}
varImp(kpls.dv)
```


## Penalized Models

```{r}
glmnGrid <- expand.grid(
    .alpha = c(0, 0.1, 0.2, 0.4, 0.6, 0.8, 1), 
    .lambda = seq(0.1, 0.2, length = 40)
)
```

```{r}
if (!file.exists("models/glmnet_dv.Rds")) {
    set.seed(1056)
    glmnet.dv <- train(
        Party ~ .,
        data = train.dv[, -c(1, hc.dv)],
        method = "glmnet",
        trControl = ctrl,
        metric = "ROC",
        tuneGrid = glmnGrid,
        preProcess = c("nzv", "pca")
    )
    
    saveRDS(glmnet.dv, "models/glmnet_dv.Rds")

} else {
    library(glmnet)
    glmnet.dv <- readRDS("models/glmnet_dv.Rds")
}
```
```{r}
library(glmnet)
glmnGrid <- expand.grid(
    .alpha = c(0, 0.1, 0.2, 0.4, 0.6, 0.8, 1), 
    .lambda = seq(0.1, 0.2, length = 40)
)
```


```{r}
set.seed(1056)
glmnet.dv <- train(
    Party ~ .,
    data = train.dv[, -c(1, hc.dv)],
    method = "glmnet",
    trControl = ctrl,
    metric = "ROC",
    tuneGrid = glmnGrid,
    preProcess = c("nzv", "pca")
)
```


## Nearest Shrunken Centroids

```{r}
nscGrid <- data.frame(.threshold = 0:25)
```

```{r}
if (!file.exists("models/nsc_dv.Rds")) {
    set.seed(1056)
    nsc.dv <- train(
        Party ~ .,
        data = train.dv[, -c(1, hc.dv)],
        method = "pam",
        trControl = ctrl,
        metric = "ROC",
        tuneGrid = nscGrid,
        preProcess = c("center", "scale", "nzv")
    )
    
    saveRDS(nsc.dv, "models/nsc_dv.Rds")

} else {
    library(pamr)
    nsc.dv <- readRDS("models/nsc_dv.Rds")
}
```

```{r}
pls.dv
```

```{r}
glmnet.dv
```

```{r}
nsc.dv
```

```{r}
pred1 <- predict(pls.dv, valid.dv[, -c(1, hc.dv)])
pred2 <- predict(glmnet.dv, valid.dv[, -c(1, hc.dv)])
pred3 <- predict(nsc.dv, valid.dv[, -c(1, hc.dv)])
```

```{r}
confusionMatrix(pred1, valid.party)
```

```{r}
confusionMatrix(pred2, valid.party)
```

```{r}
confusionMatrix(pred3, valid.party)
```

```{r}
resamps <- resamples(list(pls = pls.dv, glmnet = glmnet.mca))
modelCor(resamps)
```

```{r}
pred.pls <- predict(pls.dv, valid.dv[, -c(1, hc.dv)])
pred.glmnet <- predict(glmnet.mca, valid.mca)
```

```{r}
valid.avg <- data_frame(pred.pls, pred.glmnet)
mod.avg <- train(x = valid.avg, y = valid.party, method = "rf")
pred.avg.valid <- predict(mod.avg, valid.avg)
confusionMatrix(pred.avg.valid, valid.party)
```

```{r}
pred.test.pls <- predict(pls.dv, test.dv[, -c(1, hc.dv)])
pred.test.glmnet <- predict(glmnet.mca, test.mca)
test.avg <- data_frame(pred.test.pls, pred.test.glmnet)
pred.test.avg <- predict(mod.avg, test.avg)
```

```{r}
test.submit <- data_frame(USER_ID = testing$USER_ID, Predictions = pred.test.avg)

mod <- str_replace_all(as.character(Sys.time()), "-|:| ", "")
write_csv(test.submit, paste0("submission_", mod, ".csv"))
```

